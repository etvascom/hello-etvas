# Etvas App

An Etvas App is an application (both Back and Front End) that can run inside an `iframe` fully integrated in the Etvas Customer Portal. It **must** be hosted on a `HTTPS` URL, so the Etvas Customer Portal can load it.

Each product listed in Customer Portal has the URL of the Etvas App configured as a property. When the End Customer uses the product (after the purchase process is successfully finished), the Etvas App is loaded from the specified URL.

## Security

The communication between Etvas App and Etvas Platform has to include two elements:

- A secret API KEY (non-shareable), stored exclusively in the Back-End Etvas App
- A token (shareable), stored in the Front-End Etvas App

#### The API Key

The API key is generated by Etvas Platform for each Service Partner and must not be used by the Front-End Etvas App and it it typically stored in an environment variable for the Back-End Etvas App. We will provide you with an API KEY.

#### The token

The token is received in the query when the Customer Portal loads the application. You can easily verify the token with our dedicated REST endpoint.

It is a JWT token with the following structure:

```
{
  "purId": "-- UUID for purchase id --",
  "prodId": "-- UUID for product id --",
  "spId": "-- UUID for service partner id --",
  "scope": "purchase",
  "sub": "-- UUID for customer id --",
  "iss": "https://etvas.com/",
  "jti": "-- unique identifier for this token --",
  "iat": 1587713395,
  "exp": 1587716995
}
```

## The information flow

Each call to Etvas Platform must include in headers:

```
Accept: application/json
Content-Type: application/json
x-api-key: __API_KEY__
Authorization: __token__
```

Please note, although it is a Bearer token, the `Authorization` header does not include the `Bearer` prefix.

### 1. Etvas Platform calls the Etvas App when a purchase is made

Etvas Platform will call after a successful purchase with the Etvas Customer ID:

```
POST https://etvas-app-url.dom/purchase HTTP/1.1

Content-Type: application/json
x-api-key: _the_provided_api_key

{
  "userId": "the-etvas-customer-uuid"
}
```

The Etvas App **MUST** respond with a `HTTP/1.1 200 OK` response.

### 2. The Etvas App is loaded

When the Etvas App is loaded by the Etvas Customer platform, it receives in the URL the `token`. This token is scoped to the purchase.

### 3. The Etvas App gets the customer profile

Using the token, the Etvas App can load the customer profile:

```
GET https://api.etvas-dev.xyz/users/profile HTTP/1.1

Accept: application/json
```

The response is:

```
HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": "-etvas-customer-id-"
  "email": "customer@etvas.com"
  "firstName": "Jon"
  "lastName": "Appleseed"
  "phoneNumber": "+1123445677899"
}
```

### 4. The Etvas App can save and load additional-data

Etvas Platform will allow any Etvas App to store and retrieve information in isolation, meaning it **is not** common to the customer, purchase, product or service partner, but specific to all of:

- The current customer
- The current purchase
- The current product

The data stored and retrieved can be only a `String` and can have a maximum of 100K in length (please keep in mind the Unicode and UTF-8 characters, which can take more than one character).

Storing additional data:

```
PUT https://api.etvas-dev.xyz/products/external-data HTTP/1.1

Content-Type: application/json
Accept: application/json

{
  "data": "data to be stored, max 100k"
}
```

A successful response should be `HTTP/1.1 204 No-Content`

Retrieving additional data:

```
GET https://api.etvas-dev.xyz/products/external-data HTTP/1.1

Accept: application/json

{
  "data": "previously saved data"
}
```

In case of error **OR** if there's no data previously stored, you might get a `HTTP/1.1 404 Not Found` error response.

For deleting this data, you may `PUT` with a body of:

```
{
  "data": ""
}
```

or call:

```
DELETE https://api.etvas-dev.xyz/products/external-data HTTP/1.1

Accept: application/json
```

A successful response should be `HTTP/1.1 204 No-Content`

### Error responses

You might get `HTTP/1.1 404 - Not Found` if the resource is not found. If the token or the API KEY is not correct, you can receive `HTTP/1.1 401 Unauthorized` or `HTTP/1.1 403 Forbidden` depending on the point in which the error is caught on our servers. The body of the response will include as much as possible details and reasons about the error.
